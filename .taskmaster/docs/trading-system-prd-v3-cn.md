# 轻量级事件驱动型量化交易与回测系统 - PRD v2.0

## 概述

本产品是一个专为中低频（非HFT）交易策略设计的轻量级、高度可扩展的集成式交易与回测平台。系统采用事件驱动架构（EDA），支持实时交易和历史回测，初期将部署于云端（AWS），为量化交易者提供稳定可靠的自动化交易解决方案。

### 核心问题
- 传统交易系统架构复杂，部署成本高，难以适应快速变化的市场需求
- 策略开发与实盘交易之间存在代码复用障碍，导致回测结果与实盘表现偏差大
- 缺乏轻量级但功能完整的量化交易解决方案，特别是针对个人交易者和小型团队
- 现有系统扩展性差，添加新的经纪商或数据源需要大量代码修改

### 目标用户
- **主要用户**: 个人量化交易者、小型对冲基金、量化研究团队
- **次要用户**: 学习量化交易的开发者、策略研究人员

### 价值主张
- **即插即用**: 通过模块化设计，新策略开发时间<2小时，新经纪商接入时间<1天
- **高可靠性**: 7x24小时稳定运行，自动故障恢复，系统可用性>99.5%
- **低延迟**: 事件处理延迟<100ms，订单执行延迟<500ms，满足中低频交易需求
- **成本优化**: 云端部署成本<$100/月，支持多策略并行运行

## 核心功能

### 1. 事件驱动核心引擎
**功能描述**: 基于异步消息队列的高性能事件总线，支持事件的生产、消费和分发

**重要性**: 
- 实现组件间的松耦合，提高系统可维护性和可扩展性
- 支持实时响应市场变化，降低延迟
- 便于系统调试和故障恢复

**工作原理**:
- 使用Python asyncio + Redis Streams实现高性能事件处理
- 支持四种核心事件类型：MarketDataEvent、OrderEvent、FillEvent、SignalEvent
- 事件持久化和重播机制，支持系统恢复和调试
- 保证事件顺序性和幂等性

### 2. 模块化经纪商接口
**功能描述**: 抽象的经纪商接口层，支持多家经纪商的统一接入

**重要性**:
- 降低对特定经纪商的依赖，提高系统灵活性
- 统一的接口简化策略开发，无需关心底层实现细节
- 支持模拟交易和实盘交易的无缝切换

**工作原理**:
- AbstractBroker基类定义标准接口
- 初期实现Binance和Interactive Brokers适配器
- 内置Paper Trading模拟器，行为与实盘一致
- 支持核心功能：订单管理、持仓查询、余额管理

### 3. 多源数据聚合系统
**功能描述**: 支持多数据源接入，提供统一的数据访问接口

**重要性**:
- 确保数据的可靠性和完整性
- 支持多时间周期的数据处理
- 本地缓存减少API调用成本

**工作原理**:
- AbstractDataSource基类支持历史数据和实时数据
- 智能缓存机制，减少API调用>80%
- 数据质量检查，自动处理缺失值和异常值
- 支持多种时间周期：1m、5m、15m、1h、1d

### 4. 策略开发框架
**功能描述**: 提供标准化的策略开发接口和常用策略模板

**重要性**:
- 加速策略开发，降低入门门槛
- 确保策略代码在回测和实盘环境100%复用
- 内置性能指标计算，便于策略评估

**工作原理**:
- AbstractStrategy基类提供事件处理接口
- 支持Bar-based和Tick-based策略
- 策略状态管理和参数优化
- 内置示例策略：MA交叉、均值回归、动量

### 5. 高精度回测引擎
**功能描述**: 支持历史数据回测，精确模拟真实交易环境

**重要性**:
- 验证策略有效性，降低实盘风险
- 提供详细的性能分析报告
- 支持参数优化和敏感性分析

**工作原理**:
- 与实盘共享相同的策略代码和风险管理模块
- 精确的成本模拟（手续费、滑点、市场冲击）
- 回测速度>1000倍实时
- 生成包含15+指标的详细报告（夏普比率、最大回撤等）

### 6. 风险管理系统
**功能描述**: 实时监控和控制交易风险

**重要性**:
- 保护资金安全，防止重大损失
- 确保合规性
- 支持多层次的风险控制

**工作原理**:
- 仓位限制、止损止盈、最大回撤控制
- 实时风险指标计算和监控
- 紧急停止机制
- 风险事件日志和告警

### 7. 用户界面
**功能描述**: 提供TUI和Web两种界面选择

**重要性**:
- 实时系统状态监控
- 便捷的手动干预能力
- 支持移动端访问

**工作原理**:
- 阶段1: Textual框架的TUI界面，支持快捷键操作
- 阶段2: FastAPI + React的Web界面，支持WebSocket实时通信
- 统一的RESTful API设计
- 移动端响应式布局

## 用户体验

### 用户角色定义

#### 1. 专业量化交易者 - "Alex"
- **背景**: 5年量化交易经验，精通Python，管理<$1M资金
- **需求**: 稳定的执行系统，低延迟，多策略并行执行
- **痛点**: 现有系统部署复杂，成本高，难以定制

#### 2. 策略研究员 - "Sarah"
- **背景**: 金融工程硕士，2年策略研究经验
- **需求**: 快速策略验证，准确的回测结果
- **痛点**: 回测与实盘代码不一致，结果偏差大

#### 3. 独立交易者 - "Mike"
- **背景**: 兼职交易，基础编程技能，追求被动收入
- **需求**: 易于部署和维护，成本可控
- **痛点**: 缺乏7x24小时监控能力，系统稳定性差

### 关键用户流程

#### 1. 策略开发流程
```
开发者 → 继承AbstractStrategy → 实现策略逻辑 → 
本地回测验证 → 参数优化 → 
Paper Trading测试 → 部署实盘 → 监控调整
```

#### 2. 系统部署流程
```
用户 → 配置环境变量 → Docker Compose启动 → 
连接经纪商 → 配置数据源 → 加载策略 → 
启动监控 → 开始交易
```

#### 3. 日常监控流程
```
交易者 → 打开TUI/Web界面 → 查看持仓/盈亏 → 
检查策略状态 → 查看风险指标 → 
调整参数 → 查看日志 → 导出报告
```

### UI/UX设计原则

#### TUI设计原则
- **信息密度优先**: 单屏显示所有关键信息
- **键盘操作**: 支持Vim风格快捷键
- **实时更新**: 1秒刷新频率，避免闪烁
- **颜色编码**: 红绿表示盈亏，黄色警告，白色常规

#### Web界面设计原则
- **响应式设计**: 支持桌面、平板、手机
- **暗色主题**: 减少长时间监控的视觉疲劳
- **可定制仪表板**: 用户自定义布局和组件
- **实时图表**: 使用WebSocket推送，流畅动画

# 技术架构

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面                              │
│                    (TUI / Web仪表板)                         │
└─────────────────────────┬───────────────────────────────────┘
                          │ REST API / WebSocket
┌─────────────────────────┴───────────────────────────────────┐
│                     API网关 (FastAPI)                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────┴───────────────────────────────────┐
│                 事件总线 (内存队列 → Redis)                   │
└──┬──────────┬──────────┬──────────┬──────────┬─────────────┘
   │          │          │          │          │
┌──┴───┐  ┌──┴───┐  ┌──┴───┐  ┌──┴───┐  ┌──┴───┐
│数据  │  │交易  │  │风险  │  │投资  │  │回测  │
│引擎  │  │引擎  │  │引擎  │  │组合  │  │引擎  │
└──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘
   │          │          │          │          │
┌──┴──────────┴──────────┴──────────┴──────────┴─────────────┐
│              持久化层 (SQLite → PostgreSQL)                  │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件设计

### 1. 事件总线
- **技术栈**: 内存队列 → Redis Streams（渐进式升级）
- **设计模式**: 发布-订阅模式
- **关键特性**: 
  - 事件持久化和重播
  - 至少一次投递保证
  - 事件顺序保证
  - 背压控制机制

### 2. 数据引擎
- **职责**: 数据采集、清洗、标准化、分发
- **数据流**: 
  ```
  外部数据源 → 数据验证 → 格式转换 → 
  本地缓存 → 事件发布
  ```
- **性能指标**: 
  - 数据延迟 < 2秒
  - 缓存命中率 > 80%

### 3. 交易引擎
- **职责**: 策略执行、信号生成、订单管理
- **状态机设计**: 
  ```
  空闲 → 信号生成 → 订单发送 → 
  订单成交 → 持仓更新 → 空闲
  ```
- **并发控制**: 使用asyncio协程池管理多策略

### 4. 风险引擎
- **职责**: 实时风险监控、限制执行、紧急停止
- **风险指标**: 
  - 实时盈亏（P&L）
  - 风险敞口
  - 最大回撤
  - 夏普比率

### 5. 投资组合管理器
- **职责**: 资金分配、仓位管理、多策略协调
- **核心功能**: 
  - Kelly准则资金管理
  - 动态仓位调整
  - 策略相关性分析

## 数据模型

### 核心实体

```python
# 市场数据
@dataclass
class MarketData:
    symbol: str
    timestamp: datetime
    open: float
    high: float
    low: float
    close: float
    volume: float
    
# 订单
@dataclass
class Order:
    id: str
    symbol: str
    side: OrderSide  # 买入/卖出
    type: OrderType  # 市价/限价
    quantity: float
    price: Optional[float]
    status: OrderStatus
    created_at: datetime
    updated_at: datetime
    
# 持仓
@dataclass
class Position:
    symbol: str
    quantity: float
    avg_price: float
    current_price: float
    unrealized_pnl: float
    realized_pnl: float
    opened_at: datetime
    
# 策略状态
@dataclass
class StrategyState:
    strategy_id: str
    parameters: Dict[str, Any]
    positions: List[Position]
    performance: Dict[str, float]
    last_update: datetime
    is_active: bool
```

## API设计

### RESTful API端点

```
# 系统控制
POST   /api/v1/system/start
POST   /api/v1/system/stop
GET    /api/v1/system/status
GET    /api/v1/system/health

# 策略管理
GET    /api/v1/strategies
POST   /api/v1/strategies
PUT    /api/v1/strategies/{id}
DELETE /api/v1/strategies/{id}
POST   /api/v1/strategies/{id}/start
POST   /api/v1/strategies/{id}/stop
GET    /api/v1/strategies/{id}/performance

# 交易查询
GET    /api/v1/positions
GET    /api/v1/orders
GET    /api/v1/trades
GET    /api/v1/performance

# 回测
POST   /api/v1/backtest
GET    /api/v1/backtest/{id}/status
GET    /api/v1/backtest/{id}/results
DELETE /api/v1/backtest/{id}

# 风险管理
GET    /api/v1/risk/metrics
POST   /api/v1/risk/limits
GET    /api/v1/risk/alerts
```

### WebSocket订阅

```
# 实时数据流
ws://localhost:8000/ws/market/{symbol}
ws://localhost:8000/ws/positions
ws://localhost:8000/ws/orders
ws://localhost:8000/ws/performance
ws://localhost:8000/ws/alerts
```

## 基础设施要求

### 开发环境
- Python 3.11+
- Docker & Docker Compose
- Redis 6.0+（从阶段2开始）
- SQLite 3.35+
- Git（使用常规提交）

### 生产环境（AWS）
- **计算**: ECS Fargate（初始1 vCPU，2GB RAM）
- **存储**: EFS用于持久数据
- **缓存**: ElastiCache Redis（从阶段3开始）
- **监控**: CloudWatch + X-Ray
- **网络**: 带私有子网的VPC
- **预估成本**: <$100/月

# 开发路线图（修订版）

## Pre-MVP: 技术验证（2周）

### 目标
验证核心技术可行性，降低后续风险

### 范围
1. **技术探索（并行）**
   - Binance WebSocket稳定性测试
   - IB API连接测试
   - asyncio vs threading基准测试
   - 消息队列性能测试

2. **概念验证**
   - 基础事件循环实现
   - 简单市场数据接收
   - 控制台输出（无需TUI）
   - 基础paper trading逻辑

### 验收标准
- [ ] 成功接收并打印实时行情
- [ ] 模拟订单发送和跟踪
- [ ] 8小时连续运行无崩溃
- [ ] 记录所有发现的技术限制

## 阶段1: 真正的MVP（3-4周）

### 目标
构建真正最小可行产品，实现完整交易循环

### 范围
1. **事件驱动核心**
   - 完整的asyncio事件循环
   - 内存消息队列
   - 四种核心事件类型

2. **基础数据引擎**
   - 单一Binance数据源
   - 仅支持1分钟K线
   - 简单内存缓存

3. **最小交易引擎**
   - 单一MA交叉策略
   - 基础订单管理
   - 仅Paper Trading

4. **基本TUI**
   - 价格显示
   - 持仓跟踪
   - 基础日志

### 验收标准
- [ ] 完整交易循环演示
- [ ] TUI显示实时盈亏
- [ ] 24小时稳定性测试通过
- [ ] 事件处理延迟<100ms

## 阶段2: 策略框架与回测（3周）

### 目标
建立完整的策略开发和回测框架

### 并行工作流
- **流A**: 策略框架
- **流B**: 回测引擎
- **流C**: 经纪商API研究

### 范围
1. **策略框架**
   - AbstractStrategy实现
   - 3个示例策略
   - 参数管理
   - 状态持久化

2. **回测引擎**
   - Bar-based回测
   - 精确成本模型
   - 性能指标
   - 报告生成

3. **数据增强**
   - SQLite存储
   - 多时间周期
   - 数据质量检查

### 验收标准
- [ ] 回测与实盘100%代码复用
- [ ] 回测速度>1000倍实时
- [ ] 报告包含15+指标
- [ ] 结果可重现

## 阶段3: 多经纪商与风险管理（3周）

### 目标
实现真实交易能力和适当的风险控制

### 并行工作流
- **流A**: 经纪商集成
- **流B**: 风险管理
- **流C**: Web API设计

### 范围
1. **经纪商接口**
   - Binance实盘交易
   - IB连接
   - 统一错误处理
   - 速率限制管理

2. **风险管理**
   - 仓位限制
   - 止损/止盈
   - 紧急停止
   - 风险指标

3. **系统健壮性**
   - 自动重连
   - 状态持久化
   - 优雅降级

### 验收标准
- [ ] Binance测试网实盘交易
- [ ] IB模拟账户正常工作
- [ ] 断线恢复<30秒
- [ ] 7天稳定性测试通过

## 阶段4: Web界面与监控（3周）

### 目标
提供现代化Web界面和全面监控

### 并行工作流
- **流A**: Web后端
- **流B**: Web前端
- **流C**: 性能优化

### 范围
1. **Web后端**
   - FastAPI REST API
   - WebSocket实时通信
   - 基础认证
   - API速率限制

2. **Web前端**
   - React + TypeScript
   - 实时图表
   - 移动端响应式
   - 暗色主题

3. **监控**
   - 指标收集
   - 告警系统
   - 日志聚合
   - 性能仪表板

### 验收标准
- [ ] API响应时间<200ms
- [ ] 前端加载时间<3秒
- [ ] 移动端功能验证
- [ ] 100%监控覆盖

## 阶段5: 高级功能与生产部署（4-6周）

### 目标
增强功能，优化性能，生产部署

### 范围
1. **高级功能**
   - 多策略执行
   - 投资组合优化
   - 高级风险指标
   - 策略市场

2. **性能优化**
   - Redis Streams迁移
   - 数据库优化
   - 缓存改进
   - 水平扩展

3. **生产部署**
   - 基础设施即代码
   - CI/CD管道
   - 安全加固
   - 灾难恢复

### 验收标准
- [ ] 10+并发策略
- [ ] 延迟降低30%
- [ ] 一键部署
- [ ] 安全审计通过

# 逻辑依赖链

## 开发依赖关系图

```
Pre-MVP技术验证
    ├── 核心事件循环 ←────────────────┐
    ├── 经纪商API测试                 │
    └── 性能基准测试                  │
                ↓                    │
        阶段1: MVP核心               │
            ├── 事件驱动引擎         │
            ├── 基础数据引擎         │
            ├── 简单交易引擎         │
            └── 最小TUI             │
                    ↓               │
        ┌───────────┴───────────┐   │
        │                       │   │
阶段2: 策略框架          阶段3: 经纪商与风险
    ├── 抽象策略             ├── 实盘交易
    ├── 回测引擎             ├── 风险控制
    └── 示例策略             └── 监控
                │                   │
                └───────┬───────────┘
                        ↓
                阶段4: Web UI
                    ├── REST API
                    ├── WebSocket
                    └── React前端
                            ↓
                阶段5: 生产部署
                    ├── 优化
                    ├── 扩展
                    └── 部署
```

## 渐进式架构演进

### 第1阶段: MVP（第1-6周）
```
简单架构:
- 内存事件队列
- 尽可能同步处理
- SQLite持久化
- 单体部署
```

### 第2阶段: 成长（第7-12周）
```
增强架构:
- 全面异步处理
- 基础监控
- 多数据源
- 容器化部署
```

### 第3阶段: 扩展（第13-20周）
```
生产架构:
- Redis Streams事件总线
- 微服务选项
- 完整可观察性
- 自动扩缩容
```

## 测试驱动的里程碑

### 里程碑1: MVP完成（第6周）
- 单元测试覆盖率>80%
- 核心流程集成测试
- 1000事件/秒性能
- 24小时稳定性验证

### 里程碑2: Beta就绪（第12周）
- 回测准确性验证
- API集成测试完成
- 48小时稳定性验证
- 5个beta用户加入

### 里程碑3: 生产就绪（第20周）
- 安全渗透测试
- 灾难恢复测试
- 7天稳定性验证
- 性能基准达标

# 风险与缓解措施

## 技术风险

### 1. 事件丢失风险
- **风险**: 系统崩溃或网络中断导致事件丢失
- **影响**: 高 - 可能导致信号遗漏或重复下单
- **缓解措施**: 
  - 实现事件持久化（Redis Streams）
  - 添加事件序列号和幂等性检查
  - 定期检查点机制
  - 事件重播能力

### 2. 延迟累积
- **风险**: 事件处理延迟逐渐累积
- **影响**: 中 - 影响策略时效性
- **缓解措施**: 
  - 实时队列深度监控
  - 实现背压控制
  - 性能基准测试和优化
  - 适当的并行处理

### 3. 数据质量问题
- **风险**: 异常数据导致策略误判
- **影响**: 高 - 可能造成重大交易损失
- **缓解措施**: 
  - 多层数据验证
  - 异常值检测和过滤
  - 数据源冗余
  - 异常情况断路器

### 4. 经纪商API不稳定
- **风险**: 第三方API变更或不稳定
- **影响**: 高 - 交易中断
- **缓解措施**: 
  - 早期API验证（Pre-MVP）
  - 抽象层便于更新
  - 多经纪商支持
  - 优雅降级

## 业务风险

### 1. 监管合规
- **风险**: 不同司法管辖区的交易法规差异
- **影响**: 高 - 潜在法律问题
- **缓解措施**: 
  - 明确的服务条款和免责声明
  - 实现必要的合规功能
  - 审计日志功能
  - 咨询法律专家

### 2. 资金安全
- **风险**: API密钥泄露或滥用
- **影响**: 极高 - 直接财务损失
- **缓解措施**: 
  - 加密密钥存储
  - IP白名单限制
  - 提现限制
  - 多因素认证

### 3. 策略失效
- **风险**: 市场制度变化使策略失效
- **影响**: 中 - 收益减少或亏损
- **缓解措施**: 
  - 实时性能监控
  - 亏损时自动停止策略
  - 定期策略审查周期
  - 鼓励多样化

## 运营风险

### 1. 系统可用性
- **风险**: 云服务中断
- **影响**: 高 - 无法交易
- **缓解措施**: 
  - 多可用区部署
  - 本地备份方案
  - 故障转移机制
  - SLA监控

### 2. 成本超支
- **风险**: 云成本超出预算
- **影响**: 低 - 运营成本增加
- **缓解措施**: 
  - 成本告警和限制
  - 资源优化
  - 定期成本审查
  - 预留实例规划

# MVP需求总结

## 核心功能（P0 - 必须具备）

### Pre-MVP验证
- [x] Binance WebSocket连接
- [x] 基础事件循环证明
- [x] 控制台数据显示
- [x] 8小时稳定性测试

### MVP功能
- [x] 完整的事件驱动引擎
- [x] 单一数据源（Binance）
- [x] MA交叉策略
- [x] Paper trading执行
- [x] 基础TUI界面
- [x] 24小时稳定性

## 延期功能（P1/P2）

### P1（下一版本）
- 多策略支持
- 完整回测引擎
- Web界面
- 实盘交易能力

### P2（未来）
- 高级风险管理
- 参数优化
- 移动应用
- 策略市场

## 成功指标

### 技术指标
- **性能**: 事件延迟<100ms，内存使用<1GB
- **可靠性**: 24小时测试通过，自动恢复>95%
- **可扩展性**: 支持10+策略，1000+事件/秒

### 业务指标
- **易用性**: 新策略<2小时，部署<30分钟
- **成本**: 月度运营<$100
- **采用率**: 第12周达到10+ beta用户

### 质量指标
- **测试**: >80%代码覆盖率，所有关键路径测试
- **文档**: 100% API文档化，设置指南完整
- **安全**: 渗透测试，加密存储

# 附录

## 技术决策记录

### ADR-001: Asyncio优于Threading
- **状态**: 已接受
- **背景**: 需要高效处理多个I/O操作
- **决策**: 使用asyncio作为主要并发模型
- **后果**: 团队需要async/await培训，更好的I/O性能

### ADR-002: 渐进式架构
- **状态**: 已接受
- **背景**: 平衡简单性和可扩展性
- **决策**: 从简单开始，根据需求演进架构
- **后果**: 更多重构但初始交付更快

### ADR-003: 先使用内存队列
- **状态**: 已接受
- **背景**: Redis增加了MVP的复杂性
- **决策**: MVP使用内存队列，后期迁移
- **后果**: 初期无持久化但部署更简单

## 开发指南

### 代码标准
```python
# 策略结构示例
class MyStrategy(AbstractStrategy):
    """遵循团队标准的策略实现。"""
    
    def __init__(self, params: StrategyParams):
        super().__init__(params)
        self.validate_parameters()
    
    async def on_bar(self, bar: MarketData) -> Optional[Signal]:
        """处理新的K线数据。"""
        # 实现代码
        pass
```

### Git工作流
```bash
# 功能分支工作流
git checkout -b feature/strategy-framework
# 常规提交
git commit -m "feat(strategy): add abstract base class"
# 带测试的PR
git push origin feature/strategy-framework
```

### 测试策略
```python
# 测试结构
tests/
├── unit/           # 快速、隔离的测试
├── integration/    # 组件交互测试
├── e2e/           # 完整系统测试
└── performance/   # 基准测试
```

## 监控和指标

### 关键性能指标
```yaml
系统健康:
  - 正常运行时间: >99.5%
  - 延迟P99: <100ms
  - 错误率: <0.1%
  
业务指标:
  - 活跃策略: 数量
  - 日交易量: 美元
  - 用户增长: %/月
  
开发速度:
  - Sprint速度: 点数
  - Bug发现率: bugs/周
  - 生产时间: 天数
```

### 告警阈值
```yaml
严重告警:
  - 系统宕机: 立即
  - 订单失败率>1%: 立即
  - 延迟>500ms: 5分钟
  
警告告警:
  - 内存使用>80%: 15分钟
  - API速率限制>80%: 15分钟
  - 磁盘空间<20%: 1小时
```

## 参考资源

### 技术文档
- Python asyncio: https://docs.python.org/3/library/asyncio.html
- FastAPI: https://fastapi.tiangolo.com/
- Redis Streams: https://redis.io/docs/data-types/streams/
- Docker最佳实践: https://docs.docker.com/develop/dev-best-practices/

### 交易API
- Binance API: https://binance-docs.github.io/apidocs/
- Interactive Brokers: https://interactivebrokers.github.io/
- FIX协议: https://www.fixtrading.org/

### 监控工具
- Prometheus: https://prometheus.io/docs/
- Grafana: https://grafana.com/docs/
- OpenTelemetry: https://opentelemetry.io/docs/

### 社区资源
- /r/algotrading: 活跃的社区讨论
- QuantConnect: 学习资源和论坛
- Python Quants: https://python-quants.com/

## 版本历史

- **v2.0**（当前）: 主要路线图修订，采用渐进式架构
- **v1.0**: 初始PRD，采用线性开发方法